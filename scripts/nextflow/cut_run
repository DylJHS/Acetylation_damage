#!/bin/bash
#SBATCH --job-name=cutandrun
#SBATCH --output=/hpc/shared/onco_janssen/dhaynessimmons/projects/Dros_H3K9ac_bulkChIC_Analysis/logs/cutandrun-%j.out
#SBATCH --error=/hpc/shared/onco_janssen/dhaynessimmons/projects/Dros_H3K9ac_bulkChIC_Analysis/logs/cutandrun-%j.err
#SBATCH --time=92:00:00
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=12
#SBATCH --mem=100G
#SBATCH --mail-type=all
#SBATCH --mail-user=d.j.haynes-simmons@umcutrecht.nl

# Load the workflow configuration
source /hpc/shared/onco_janssen/dhaynessimmons/projects/Dros_H3K9ac_bulkChIC_Analysis/scripts/config/nf_env_config.sh

# Put all Nextflow state under project space
export NXF_HOME=/hpc/shared/onco_janssen/dhaynessimmons/projects/Dros_H3K9ac_bulkChIC_Analysis/.nextflow_home
export NXF_WORK=/hpc/shared/onco_janssen/dhaynessimmons/projects/Dros_H3K9ac_bulkChIC_Analysis/work
# (NXF_WORK is respected by newer Nextflow; also pass -work-dir as belt & braces)

# Logs
export NXF_LOG_FILE=/hpc/shared/onco_janssen/dhaynessimmons/projects/Dros_H3K9ac_bulkChIC_Analysis/logs/nextflow-${SLURM_JOB_ID}.log

# Containers: cover both Apptainer and Singularity names
export APPTAINER_CACHEDIR=/hpc/shared/onco_janssen/dhaynessimmons/projects/Dros_H3K9ac_bulkChIC_Analysis/containers
export APPTAINER_CACHE_DIR="$APPTAINER_CACHEDIR"
export SINGULARITY_CACHEDIR="$APPTAINER_CACHEDIR"

# Temp for everything that honours TMPDIR
export TMP="$TEMP_DIR"
export TEMP="$TEMP_DIR"

# (Optional but helpful) Keep Java temp off $HOME as well
export JAVA_TOOL_OPTIONS="-Djava.io.tmpdir=$TEMP_DIR"

nextflow run nf-core/cutandrun \
  --input /hpc/shared/onco_janssen/dhaynessimmons/projects/Dros_H3K9ac_bulkChIC_Analysis/data/SEND-bulkChIC-UMC-JAN-003-008-2/human_cut_run_samplesheet.csv \
  --outdir /hpc/shared/onco_janssen/dhaynessimmons/projects/Dros_H3K9ac_bulkChIC_Analysis/results/human_alignments \
  --genome GRCh38 \
  --use_control false \
  --seacr_peak_threshold 0.05 \
  --seacr_norm non --seacr_stringent relaxed \
  --peakcaller seacr \
  --normalisation_mode CPM \
  --replicate_threshold 2 \
  --spikein_bowtie2 null \
  --spikein_fasta null \
  -profile singularity
